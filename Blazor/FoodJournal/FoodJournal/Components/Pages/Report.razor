@page "/report"

@inject ReportService ReportService

<PageTitle>Meal Report</PageTitle>

<div class="container-lg py-4">
    <div class="card shadow border-0 mb-4" style="border-radius: 15px;">
        <div class="card-header bg-white border-0 pt-4 px-4">
            <h2 class="fw-bold" style="color: var(--primary-color);">Consumption Report</h2>
            <p class="text-muted">See how many times you've had each food in a period.</p>
        </div>
        <div class="card-body px-4">
            <div class="row g-3 align-items-end mb-4">
                <div class="col-md-4">
                    <label class="form-label fw-bold">From</label>
                    <input type="date" @bind="startDate" class="form-control border-0 shadow-sm" style="background-color: #f8f9fa;"/>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">To</label>
                    <input type="date" @bind="endDate" class="form-control border-0 shadow-sm" style="background-color: #f8f9fa;"/>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-lg w-100 shadow" style="background-color: var(--secondary-color); color: white; border-radius: 10px; font-weight: bold;" @onclick="GenerateReport">
                        Generate Report
                    </button>
                </div>
            </div>

            @if (reportItems != null)
            {
                <hr class="my-4 opacity-10">
                
                @if (reportItems.Count == 0)
                {
                    <div class="text-center py-5 text-muted">
                        <img src="images/icons/icons8-grocery-bag-96.png" style="width: 80px; opacity: 0.5;" alt="Empty"/>
                        <p class="mt-3">No data for this period.</p>
                    </div>
                }
                else
                {
                    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
                        @foreach (var item in reportItems.OrderByDescending(i => i.Count))
                        {
                            <div class="col">
                                <div class="card h-100 border-0 shadow-sm text-center p-3" style="border-radius: 15px; background-color: white;">
                                    <div class="position-absolute top-0 end-0 p-2">
                                        <span class="badge rounded-pill" style="background-color: var(--accent-color); color: var(--text-color);">@item.Count times</span>
                                    </div>
                                    <div class="mb-3 mt-2">
                                        <img src="images/icons/@item.Food.Icon" alt="@item.Food.Name" style="width: 64px;"/>
                                    </div>
                                    <h6 class="fw-bold mb-1">@item.Food.Name</h6>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar" role="progressbar" style="width: @(GetPercentage(item.Count) + "%"); background-color: var(--secondary-color);"></div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private DateTime startDate = DateTime.Today.AddDays(-30);
    private DateTime endDate = DateTime.Today;
    private List<FoodCountReportViewModel>? reportItems;

    private async Task GenerateReport()
    {
        reportItems = await ReportService.CreateReport(startDate, endDate);
    }

    private int GetPercentage(int count)
    {
        if (reportItems == null || reportItems.Count == 0) return 0;
        var max = reportItems.Max(i => i.Count);
        if (max == 0) return 0;
        return (int)((double)count / max * 100);
    }
}