@page "/meals/editor"

@inject FoodService FoodService
@inject MealService MealService

<PageTitle>Meal Editor</PageTitle>

<div class="container-lg py-4">
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow border-0" style="border-radius: 15px;">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h2 class="fw-bold" style="color: var(--primary-color);">Record a Meal</h2>
                    <p class="text-muted">Fill in the details and select your foods.</p>
                </div>
                <div class="card-body px-4">
                    <EditForm Model="_meal" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator/>

                        <div class="row mb-4">
                            <div class="col-md-7 mb-3">
                                <label for="name" class="form-label fw-bold">Meal Name</label>
                                <InputText @bind-Value="_meal.Name" id="name"
                                           class="form-control form-control-lg border-0 shadow-sm"
                                           style="background-color: #f8f9fa;"
                                           placeholder="e.g. Healthy Breakfast Bowl"/>
                                <ValidationMessage For="() => _meal.Name" class="text-danger small"/>
                            </div>
                            <div class="col-md-5 mb-3">
                                <label for="date" class="form-label fw-bold">Date</label>
                                <InputDate @bind-Value="_meal.Date" id="date"
                                           class="form-control form-control-lg border-0 shadow-sm"
                                           style="background-color: #f8f9fa;"/>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold d-block mb-3">Meal Type</label>
                            <InputRadioGroup Name="meal-type" @bind-Value="_meal.MealType">
                                <div class="d-flex flex-wrap gap-3">
                                    @foreach (var type in Enum.GetValues<MealType>())
                                    {
                                        <div class="meal-type-option">
                                            <InputRadio Value="type" id="@type.ToString().ToLower()" class="btn-check"/>
                                            <label
                                                class="btn btn-outline-light shadow-sm p-3 d-flex flex-column align-items-center"
                                                for="@type.ToString().ToLower()"
                                                style="width: 100px; border-radius: 15px; transition: all 0.2s;">
                                                <img alt="@type"
                                                     src="images/icons/icons8-@type.ToString().ToLower()-96.png"
                                                     style="width: 48px;"/>
                                                <span class="mt-2 small fw-bold text-dark">@type</span>
                                            </label>
                                        </div>
                                    }
                                </div>
                            </InputRadioGroup>
                        </div>

                        <hr class="my-4 opacity-10">

                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="fw-bold mb-0">Select Food</h5>
                                    <span class="badge bg-light text-dark">@_foods.Count items</span>
                                </div>
                                <div class="food-grid p-3 rounded"
                                     style="background-color: #f8f9fa; height: 400px; overflow-y: auto;">
                                    <div class="row row-cols-3 g-2">
                                        @foreach (var food in _foods)
                                        {
                                            <div class="col">
                                                <button
                                                    class="btn btn-white shadow-sm w-100 h-100 p-2 d-flex flex-column align-items-center justify-content-center food-btn"
                                                    type="button" @onclick="() => AddFoodToMeal(food)">
                                                    <img alt="@food.Name" src="images/icons/@food.Icon"
                                                         style="width: 32px;"/>
                                                    <span class="mt-1 small text-truncate w-100">@food.Name</span>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="fw-bold mb-0">Your Selection</h5>
                                    <span class="badge"
                                          style="background-color: var(--secondary-color);">@_meal.Foods.Count selected</span>
                                </div>
                                <div class="selection-list p-3 rounded border-dashed"
                                     style="height: 400px; overflow-y: auto; border: 2px dashed #dee2e6;">
                                    @if (_meal.Foods.Count == 0)
                                    {
                                        <div
                                            class="h-100 d-flex flex-column align-items-center justify-content-center text-muted">
                                            <i class="bi bi-plus-circle mb-2" style="font-size: 2rem;"></i>
                                            <p class="small">Click on foods to add them</p>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="row row-cols-3 g-2">
                                            @foreach (var food in _meal.Foods)
                                            {
                                                <div class="col">
                                                    <div class="position-relative">
                                                        <button
                                                            class="btn btn-white shadow-sm w-100 h-100 p-2 d-flex flex-column align-items-center justify-content-center border-0"
                                                            type="button" style="background-color: white;">
                                                            <img alt="@food.Name" src="images/icons/@food.Icon"
                                                                 style="width: 32px;"/>
                                                            <span
                                                                class="mt-1 small text-truncate w-100">@food.Name</span>
                                                        </button>
                                                        <button type="button"
                                                                class="btn btn-danger btn-sm rounded-circle position-absolute top-0 start-100 translate-middle p-0"
                                                                style="width: 20px; height: 20px;"
                                                                @onclick="() => RemoveFoodFromMeal(food)">
                                                            <i class="bi bi-x" style="font-size: 14px;"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-end">
                            <button class="btn btn-lg px-5 shadow" type="submit"
                                    style="background-color: var(--primary-color); color: white; border-radius: 10px; font-weight: bold;">
                                Save Meal
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow border-0 mb-4" style="border-radius: 15px; background-color: var(--accent-color);">
                <div class="card-body p-4 text-center">
                    <img src="images/icons/icons8-kawaii-ice-cream-96.png" style="width: 64px;" alt="Quick Log"/>
                    <h5 class="fw-bold mt-3">Quick Record</h5>
                    <p class="small text-muted mb-4">Common combinations you've had recently.</p>

                    <div class="d-grid gap-2">
                        <button class="btn btn-light shadow-sm text-start p-3 d-flex align-items-center gap-3 border-0"
                                style="border-radius: 12px;">
                            <img src="images/icons/icons8-kawaii-coffee-48.png" style="width: 24px;" alt="Quick"/>
                            <div class="flex-grow-1">
                                <div class="fw-bold small">Morning Coffee & Bread</div>
                                <div class="text-muted" style="font-size: 10px;">2 items</div>
                            </div>
                            <i class="bi bi-plus-circle-fill text-primary"></i>
                        </button>
                        <button class="btn btn-light shadow-sm text-start p-3 d-flex align-items-center gap-3 border-0"
                                style="border-radius: 12px;">
                            <img src="images/icons/icons8-kawaii-broccoli-48.png" style="width: 24px;" alt="Quick"/>
                            <div class="flex-grow-1">
                                <div class="fw-bold small">Healthy Veggie Lunch</div>
                                <div class="text-muted" style="font-size: 10px;">4 items</div>
                            </div>
                            <i class="bi bi-plus-circle-fill text-primary"></i>
                        </button>
                        <button class="btn btn-light shadow-sm text-start p-3 d-flex align-items-center gap-3 border-0"
                                style="border-radius: 12px;">
                            <img src="images/icons/icons8-kawaii-cupcake-48.png" style="width: 24px;" alt="Quick"/>
                            <div class="flex-grow-1">
                                <div class="fw-bold small">Sweet Snack</div>
                                <div class="text-muted" style="font-size: 10px;">1 item</div>
                            </div>
                            <i class="bi bi-plus-circle-fill text-primary"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card shadow border-0" style="border-radius: 15px;">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3">Meal Tips</h5>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-3 d-flex gap-2">
                            <i class="bi bi-lightbulb text-warning"></i>
                            <span class="small">Try to record your meals right after eating.</span>
                        </li>
                        <li class="mb-3 d-flex gap-2">
                            <i class="bi bi-lightbulb text-warning"></i>
                            <span class="small">Adding icons makes it easier to scan your history.</span>
                        </li>
                        <li class="d-flex gap-2">
                            <i class="bi bi-lightbulb text-warning"></i>
                            <span class="small">Use the Quick Record feature for snacks!</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .meal-type-option input:checked + label {
        background-color: var(--secondary-color) !important;
        border-color: var(--secondary-color) !important;
        transform: scale(1.05);
    }

    .meal-type-option input:checked + label span {
        color: white !important;
    }

    .food-btn:hover {
        background-color: white;
        border: 1px solid var(--secondary-color) !important;
        transform: translateY(-2px);
    }

    .food-btn {
        border: 1px solid transparent !important;
        transition: all 0.2s;
    }

    .border-dashed {
        background-color: #fcfcfc;
    }
</style>

@code {
    List<Food> _foods = [];
    Meal _meal = new();

    protected override async Task OnInitializedAsync()
    {
        _foods = await FoodService.GetAllFoodsAsync();
    }

    private void AddFoodToMeal(Food food)
    {
        _meal.Foods.Add(food);
    }

    private void RemoveFoodFromMeal(Food food)
    {
        _meal.Foods.Remove(food);
    }

    private async Task HandleSubmit()
    {
        await MealService.AddMeal(new Meal { Name = _meal.Name, Date = _meal.Date, Foods = _meal.Foods, MealType = _meal.MealType });
    }

}