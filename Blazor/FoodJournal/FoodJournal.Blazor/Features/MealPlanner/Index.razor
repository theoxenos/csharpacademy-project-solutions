@page "/"
@using FoodJournal.Blazor.Features.MealPlanner.Components

@inject NavigationManager NavigationManager

@inject IDialogService DialogService
@inject IMealRepository MealRepository
@inject IRecipeService RecipeService

<MudGrid>
    @* <MudItem md="3"> *@
    @*     <MudSelect @bind-Value="_searchMode" Placeholder="Search Mode" HelperText="Select the search mode"> *@
    @*         @foreach (var searchMode in Enum.GetValues(typeof(SearchMode)).Cast<SearchMode>()) *@
    @*         { *@
    @*             <MudSelectItem Value="@searchMode">@searchMode</MudSelectItem> *@
    @*         } *@
    @*     </MudSelect> *@
    @* </MudItem> *@
    <MudItem md="10">
        <MudTextField @bind-Value="_searchTerm" Placeholder="Search Term"/>
    </MudItem>
    <MudItem md="2">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HandleSearch">Search</MudButton>
    </MudItem>
</MudGrid>
<MudGrid>
    <MudItem md="6">
        <MudText Typo="Typo.h4">Recipes</MudText>
        <MudList T="Recipe" Style="max-height: 600px; overflow-y: auto;">
            @foreach (var recipe in _recipes)
            {
                <MudListItem OnClick="@(() => RecipeSelected(recipe))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudAvatar Size="Size.Medium">
                            <MudImage Src="@recipe.ThumbnailUrl" Alt="@recipe.Name"/>
                        </MudAvatar>

                        <MudStack Spacing="0">
                            <MudStack Row="true">
                                <MudText Typo="Typo.subtitle1">@recipe.Name</MudText>
                                <MudText Typo="Typo.caption">@recipe.Ingredients.Count ingredients</MudText>
                            </MudStack>
                            <MudText Typo="Typo.subtitle2">@(recipe.Description[..60].Trim())...</MudText>
                        </MudStack>
                    </MudStack>
                </MudListItem>
            }
        </MudList>
    </MudItem>
    <MudItem md="6">
        <MudText Typo="Typo.h4">Meals</MudText>
        <MudList T="Meal">
            @foreach (var meal in _meals)
            {
                <MudListItem>
                    <MudText Typo="Typo.subtitle1">@meal.Name</MudText>
                    <MudText Typo="Typo.caption">@meal.Date.ToShortDateString()</MudText>
                </MudListItem>
            }
        </MudList>
    </MudItem>
</MudGrid>

@code
{
    private enum SearchMode
    {
        All,
        Meals,
        Recipes
    }

    private List<Meal> _meals = [];

    private List<Recipe> _recipes = [];

    private SearchMode _searchMode = SearchMode.All;
    private string _searchTerm = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _meals = await MealRepository.GetAllMealsAsync();
            _recipes = await RecipeService.SearchRecipeByNameAsync(_searchTerm);
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
    }

    private async Task HandleSearch()
    {
        _recipes = await RecipeService.SearchRecipeByNameAsync(_searchTerm);
    }

    private async Task RecipeSelected(Recipe selectedRecipe)
    {
        var parameters = new DialogParameters<RecipeModal>
        {
            { x => x.Recipe, selectedRecipe }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialogReference = await DialogService.ShowAsync<RecipeModal>(selectedRecipe.Name, parameters, options);
        var dialogResult = await dialogReference.Result;
        if (dialogResult?.Canceled is false)
        {
            NavigationManager.NavigateTo($"/meals/create/{selectedRecipe.Id}");
        }
    }
}
