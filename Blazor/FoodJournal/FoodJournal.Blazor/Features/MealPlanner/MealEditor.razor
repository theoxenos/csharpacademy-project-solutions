@page "/meals/create/{RecipeId:int?}"
@page "/meals/edit/{MealId:int?}"

@inject IIngredientService IngredientService
@inject IIngredientReportsService IngredientsReportsService
@inject IMealService MealService
@inject IRecipeService RecipeService

@inject IMealRepository MealRepository

@inject IJSRuntime JsRuntime
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudText Typo="Typo.h2" Class="mb-3">Register your meal</MudText>
<MudGrid>
    <MudItem md="6">
        <MudTextField @bind-Value="_meal.Name" Label="Meal name"/>
    </MudItem>
    <MudItem md="6">
        <MudDatePicker Label="Date" @bind-Value="_meal.Date"/>
    </MudItem>
    <MudItem md="12">
        <MudTextField @bind-Value="_meal.Description" Label="Meal description" Lines="20"/>
    </MudItem>
    <MudItem md="12">
        <MudText Typo="Typo.h6" Class="mb-2">Meal type</MudText>
        <MudButtonGroup OverrideStyles="false">
            @foreach (MealType mealType in Enum.GetValues(typeof(MealType)))
            {
                <MudButton Variant="@(_meal.Type == mealType ? Variant.Filled : Variant.Outlined)"
                           Color="@(_meal.Type == mealType ? Color.Primary : Color.Default)"
                           OnClick="@(() => _meal.Type = mealType)">
                    <div class="d-flex align-center">
                        <MudImage Alt="@mealType.ToString()" Src="@mealType.MealTypeToIconUrl()"/>
                        <MudText Typo="Typo.caption">@mealType.ToString()</MudText>
                    </div>
                </MudButton>
            }
        </MudButtonGroup>
    </MudItem>

    @* Ingredient picker (icon-first) *@
    <MudItem md="5">
        <MudPaper Class="pa-4" Elevation="1" Outlined="true">
            <MudText Typo="Typo.h6" Class="mb-2">Ingredients</MudText>

            <MudTextField T="string"
                          Value="_ingredientFilter"
                          ValueChanged="OnIngredientFilterChanged"
                          Label="Search ingredients"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Clearable="true"
                          Immediate="true"/>

            <MudDivider Class="my-3"/>

            <MudGrid Spacing="1" Style="max-height: 600px; overflow-y: auto;">
                @foreach (var ingredient in _filteredIngredients)
                {
                    <MudItem xs="4" sm="3" md="3">
                        <MudPaper Outlined="true" Class="pa-2 d-flex flex-column align-center" Style="cursor:pointer;"
                                  @onclick="@(() => AddIngredient(ingredient))">
                            <MudAvatar Size="Size.Large"
                                       Square="true"
                                       Class="mb-1"
                                       Style="width:72px;height:72px;">
                                <MudImage Src="@ingredient.ThumbnailUrl" Alt="@ingredient.Name"/>
                            </MudAvatar>
                            <MudText Typo="Typo.caption" Align="Align.Center" Style="line-height:1.1;">
                                @ingredient.Name
                            </MudText>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
        </MudPaper>
    </MudItem>

    @* Editable overview *@
    <MudItem md="7">
        <MudPaper Class="pa-4" Elevation="1" Outlined="true">
            <div class="d-flex align-center justify-space-between mb-2">
                <MudText Typo="Typo.h6">Your meal ingredients</MudText>
                <MudText Typo="Typo.caption">Total calories: @_meal.TotalCalories</MudText>
            </div>

            <MudTable Items="@_meal.Ingredients" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh Style="width: 88px;">Icon</MudTh>
                    <MudTh>Ingredient</MudTh>
                    <MudTh>Amount</MudTh>
                    <MudTh Style="width: 56px;"></MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd DataLabel="Icon">
                        <MudAvatar Size="Size.Large"
                                   Square="true"
                                   Style="width:64px;height:64px;">
                            <MudImage Src="@context.Ingredient.ThumbnailUrl" Alt="@context.Ingredient.Name"/>
                        </MudAvatar>
                    </MudTd>

                    <MudTd DataLabel="Ingredient">
                        <MudText Typo="Typo.subtitle2">@context.Ingredient.Name</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @context.Ingredient.Type
                        </MudText>
                    </MudTd>

                    <MudTd DataLabel="Amount">
                        <MudTextField @bind-Value="context.Measurement"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Placeholder="e.g. 200 g / 1 cup / 2 tbsp"
                                      Immediate="true"/>
                    </MudTd>

                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => RemoveIngredient(context))"/>
                    </MudTd>
                </RowTemplate>

                <NoRecordsContent>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Pick ingredients on the left (click the icon) to add them here.
                    </MudText>
                </NoRecordsContent>
            </MudTable>
        </MudPaper>
    </MudItem>
    <MudItem md="12" Class="mb-6 d-flex justify-end">
        <MudButton Color="Color.Success" Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Save"
                   OnClick="@SaveMeal">
            Save meal
        </MudButton>
    </MudItem>
</MudGrid>

@code {
    [Parameter] public int? RecipeId { get; set; }
    [Parameter] public int? MealId { get; set; }

    private IReadOnlyList<Ingredient> _filteredIngredients = [];
    private Meal _meal = new();

    private string _ingredientFilter = string.Empty;

    private async Task OnIngredientFilterChanged(string value)
    {
        _ingredientFilter = value;

        if (string.IsNullOrWhiteSpace(_ingredientFilter))
        {
            const int limitIngredients = 20;
            _filteredIngredients = await IngredientsReportsService.GetMostUsedIngredientsAsync(limitIngredients);
        }
        else
        {
            _filteredIngredients = await IngredientService.FilterIngredientsByNameAsync(_ingredientFilter);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _filteredIngredients = (await IngredientsReportsService.GetMostUsedIngredientsAsync(20)).ToList();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (RecipeId.HasValue)
        {
            _meal = Meal.FromRecipe(await RecipeService.GetRecipeByIdAsync(RecipeId.Value));
        }
        else if (MealId.HasValue)
        {
            var mealFromDatabase = await MealRepository.GetMealByIdAsync(MealId.Value);

            if (mealFromDatabase is null)
            {
                await ResetState();
                Snackbar.Add($"Meal with Id {MealId.Value} not found");
                return;
            }

            _meal = mealFromDatabase;
        }
        else
        {
            await ResetState();
        }
    }

    private void AddIngredient(Ingredient ingredient)
    {
        _meal.Ingredients.Add(new RecipeIngredient
        {
            Ingredient = ingredient,
            Measurement = string.Empty
        });
    }

    private void RemoveIngredient(RecipeIngredient recipeIngredient)
    {
        _meal.Ingredients.Remove(recipeIngredient);
    }

    private async Task ResetState()
    {
        _meal = new Meal();
        _ingredientFilter = string.Empty;
        _filteredIngredients = await IngredientsReportsService.GetMostUsedIngredientsAsync(20);
    }

    private async Task SaveMeal()
    {
        await MealService.AddMealAsync(_meal);
        Snackbar.Add("Meal saved successfully", Severity.Success);

        if (RecipeId.HasValue || MealId.HasValue)
        {
            NavigationManager.NavigateTo("/meals/create");
        }
        else
        {
            await ResetState();
            await JsRuntime.InvokeVoidAsync("window.scrollTo", 0, 0);
        }
    }

}