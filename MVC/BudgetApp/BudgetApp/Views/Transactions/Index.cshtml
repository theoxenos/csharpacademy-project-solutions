@model BudgetApp.Models.TransactionIndexViewModel

@{
    ViewData["Title"] = "Transactions";
}

<div class="container-fluid py-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h2 class="display-6 fw-bold mb-0">Transactions</h2>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-success shadow-sm" id="btnTransactionNew">
                <i class="bi bi-plus-lg"></i> New Transaction
            </button>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body bg-light">
            <form id="frmSearch" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label asp-for="CategoryFilter" class="form-label">Category</label>
                    <select asp-for="CategoryFilter" asp-items="@(new SelectList(Model.Categories, nameof(Category.Id), nameof(Category.Name), Model.CategoryFilter))" class="form-select">
                        <option value="0">All Categories</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label asp-for="DateFilter" class="form-label">Date</label>
                    <input asp-for="DateFilter" type="date" class="form-control"/>
                </div>
                <div class="col-md-4">
                    <label asp-for="TransactionFilter" class="form-label">Search by Name</label>
                    <div class="input-group">
                        <input asp-for="TransactionFilter" type="search" class="form-control" placeholder="Search transactions..."/>
                        <button class="btn btn-primary" type="submit">
                            Search
                        </button>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="document.getElementById('frmSearch').reset(); document.getElementById('frmSearch').dispatchEvent(new Event('submit'));">
                        Clear
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead>
                <tr>
                    <th class="ps-4">@Html.DisplayNameFor(m => m.Transactions[0].Date)</th>
                    <th>Transaction Details</th>
                    <th class="text-end">@Html.DisplayNameFor(m => m.Transactions[0].Amount)</th>
                    <th class="text-center pe-4" style="width: 150px;">Manage</th>
                </tr>
                </thead>
                <tbody id="transactionsTableRows">
                    @await Html.PartialAsync("TransactionsTableRows", Model.Transactions)
                </tbody>
            </table>
        </div>
    </div>
</div>

@* Confirmation Modal *@
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="modalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4 text-center">
                <input type="hidden" id="deleteTransactionId"/>
                <p class="mb-0 fs-5">Are you sure you want to delete this transaction?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-4">
                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger px-4" id="btnTransactionConfirmDelete">Delete Transaction</button>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("TransactionUpsertModal", Model.TransactionUpsertViewModel)

@section Scripts
{
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script src="js/resetForm.js"></script>
    <script>
        // Dynamic content
        const transactionsTableRows = document.querySelector('#transactionsTableRows');
        
        // Table buttons
        const newTransactionButton = document.querySelector('#btnTransactionNew');
        
        // Transaction modal elements
        const upsertModal = new bootstrap.Modal('#transactionUpsertModal');
        const submitUpsertModalButton = document.querySelector('#btnTransactionUpsert');
        const upsertForm = document.querySelector('#frmTransactionUpsert');
     
        // Confirm modal elements
        const confirmationModal = new bootstrap.Modal('#confirmationModal');
        const transactionDeleteIdElement = document.querySelector('#deleteTransactionId');
        const confirmDeleteButton = document.querySelector('#btnTransactionConfirmDelete');
        
        upsertForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const transaction = { 
                id: Number(formData.get('Transaction.Id')),
                date: formData.get('Transaction.Date'),
                comment: formData.get('Transaction.Comment'),
                amount: formData.get('Transaction.Amount'),
                categoryId: formData.get('Transaction.CategoryId')
            }
    
            let method = 'PUT';
            let route = `/transactions/update/${transaction.id}`;
            if (transaction.id === 0) {
                method = 'POST';
                route = '/transactions/create';
            }
    
            const init = {
                method, 
                headers: {
                    'Content-Type' : 'application/json'  
                },
                body: JSON.stringify(transaction)
             }
            const response = await fetch(route, init);
    
            if (response.status === 400) {
                // upsertForm.innerHTML = await response.text();
                return;
            } else if (!response.ok) {
                throw new Error(`HTML Error: ${response.status}`);   
            }
    
            transactionsTableRows.innerHTML = await response.text();
            upsertModal.hide();
        });
        
        submitUpsertModalButton.addEventListener('click', () => {
            // Create a new 'submit' event
            let event = new Event('submit', {
                bubbles: true, // Event will bubble up through the DOM
                cancelable: true // Event can be canceled
            });
        
            // Dispatch it on the form
            if (upsertForm.dispatchEvent(event)) {
                upsertModal.hide(); // Hide the modal only if the event wasn't canceled
            }
        });
        
        transactionsTableRows.addEventListener('click', async (event) => {
            if (!event.target) {
                return;
            }
            
            if (event.target.matches('.edit-transaction')) {
                resetFormValidation(upsertForm);
                
                const transactionId = event.target.dataset.transactionid;
                const response = await fetch('Transactions/Detail/' + transactionId);
                
                if (!response.ok) {
                    throw new Error(`HTML Error: ${response.status}`);   
                }
                
                const transaction = await response.json();
                
                upsertForm['Transaction.Id'].value = transaction.id;
                upsertForm['Transaction.Date'].value = transaction.date;
                upsertForm['Transaction.Comment'].value = transaction.comment;
                upsertForm['Transaction.Amount'].value = transaction.amount;
                upsertForm['Transaction.CategoryId'].value = transaction.categoryId;
                                
                upsertModal.show();
            } else if (event.target.matches('.delete-transaction')) {
                transactionDeleteIdElement.value = event.target.dataset.transactionid;
                confirmationModal.show();
            }
        });
        
        confirmDeleteButton.addEventListener('click', async () => {
           const transactionId = Number(transactionDeleteIdElement.value);
            const response = await fetch(`Transactions/Delete/${transactionId}`, { method: 'delete'})
            
            if (!response.ok) {
                 throw new Error(`HTML Error: ${response.status}`);   
             }
            
            confirmationModal.hide();
            transactionsTableRows.innerHTML = await response.text();
        });
        
        newTransactionButton.addEventListener('click', () =>{
            resetFormValidation(upsertForm);
            
            upsertForm['Transaction.Id'].value = '';
            upsertForm['Transaction.Date'].value = '';
            upsertForm['Transaction.Comment'].value = '';
            upsertForm['Transaction.Amount'].value = '';
            upsertForm['Transaction.CategoryId'].value = '0';
            
            upsertModal.show();
        });
        
        document.querySelector('#frmSearch').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            const searchVm = {
                CategoryFilter: formData.get('CategoryFilter'),
                DateFilter: formData.get('DateFilter'),
                TransactionFilter: formData.get('TransactionFilter')  
            };
            
            const queryString = Object.keys(searchVm).map(key => 
                `${encodeURIComponent(key)}=${encodeURIComponent(searchVm[key])}`
            ).join('&');
            
            const url = `Transactions/Filter/?${queryString}`;
            const response = await fetch(url);
            
            transactionsTableRows.innerHTML = await response.text();
        });
    </script>
}
